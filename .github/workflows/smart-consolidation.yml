name: Smart Repository Consolidation

on:
  schedule:
    # Run weekly on Sunday at 2 AM
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (analyze only, no changes)'
        required: false
        default: 'true'
        type: boolean
      source_repos:
        description: 'Source repositories (comma-separated, e.g., owner/repo1,owner/repo2)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  consolidate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check for kill switch
      id: killswitch
      run: |
        if [ -f ".chimera/AUTONOMOUS_DISABLED" ]; then
          echo "AUTONOMOUS SYSTEM DISABLED - Kill switch active"
          echo "disabled=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        echo "disabled=false" >> $GITHUB_OUTPUT
    
    - name: Read configuration
      if: steps.killswitch.outputs.disabled == 'false'
      id: config
      run: |
        if [ -f ".chimera/autonomous-config.json" ]; then
          CONSOLIDATION_ENABLED=$(cat .chimera/autonomous-config.json | grep -o '"repository_consolidation":[^,]*' | grep -o 'true\|false')
          echo "enabled=$CONSOLIDATION_ENABLED" >> $GITHUB_OUTPUT
          
          if [ "$CONSOLIDATION_ENABLED" != "true" ]; then
            echo "Repository consolidation is disabled in config"
            exit 0
          fi
        else
          echo "enabled=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Setup Node.js
      if: steps.killswitch.outputs.disabled == 'false' && steps.config.outputs.enabled == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
    
    - name: Configure Git
      if: steps.killswitch.outputs.disabled == 'false' && steps.config.outputs.enabled == 'true'
      run: |
        git config --global user.name "Chimera Consolidation Bot"
        git config --global user.email "chimera-bot@github-actions"
    
    - name: Define source repositories
      if: steps.killswitch.outputs.disabled == 'false' && steps.config.outputs.enabled == 'true'
      id: repos
      run: |
        # Use input if provided, otherwise use default list
        if [ -n "${{ github.event.inputs.source_repos }}" ]; then
          REPOS="${{ github.event.inputs.source_repos }}"
        else
          # Default source repositories
          REPOS="oconnorw225-del/quantum-engine-dashb,oconnorw225-del/shadowforge-ai-trader,oconnorw225-del/repository-web-app"
        fi
        
        echo "repos=$REPOS" >> $GITHUB_OUTPUT
        echo "Source repositories: $REPOS"
    
    - name: Clone source repositories
      if: steps.killswitch.outputs.disabled == 'false' && steps.config.outputs.enabled == 'true'
      run: |
        mkdir -p source_repos
        
        IFS=',' read -ra REPOS_ARRAY <<< "${{ steps.repos.outputs.repos }}"
        
        for repo in "${REPOS_ARRAY[@]}"; do
          repo_name=$(basename "$repo")
          echo "Cloning $repo..."
          
          # Clone with error handling
          if git clone "https://github.com/$repo.git" "source_repos/$repo_name" 2>/dev/null; then
            echo "âœ… Successfully cloned $repo"
          else
            echo "âš ï¸ Failed to clone $repo (may be private or non-existent)"
          fi
        done
    
    - name: Create backup
      if: steps.killswitch.outputs.disabled == 'false' && steps.config.outputs.enabled == 'true'
      run: |
        echo "Creating backup of current state..."
        mkdir -p backups
        
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        tar -czf "backups/pre-consolidation-$TIMESTAMP.tar.gz" \
          --exclude='node_modules' \
          --exclude='.git' \
          --exclude='dist' \
          --exclude='backups' \
          --exclude='source_repos' \
          . 2>/dev/null || true
        
        echo "Backup created: backups/pre-consolidation-$TIMESTAMP.tar.gz"
    
    - name: Analyze source repositories
      if: steps.killswitch.outputs.disabled == 'false' && steps.config.outputs.enabled == 'true'
      id: analyze
      run: |
        echo "Analyzing source repositories..."
        
        cat > analysis-report.md << EOF
        # Repository Consolidation Analysis
        
        **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Mode:** ${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'Live' }}
        
        ## Source Repositories
        
        EOF
        
        TOTAL_FILES=0
        TOTAL_SIZE=0
        
        for dir in source_repos/*; do
          if [ -d "$dir" ]; then
            repo_name=$(basename "$dir")
            file_count=$(find "$dir" -type f | wc -l)
            repo_size=$(du -sh "$dir" | cut -f1)
            
            TOTAL_FILES=$((TOTAL_FILES + file_count))
            
            echo "### $repo_name" >> analysis-report.md
            echo "" >> analysis-report.md
            echo "- Files: $file_count" >> analysis-report.md
            echo "- Size: $repo_size" >> analysis-report.md
            echo "" >> analysis-report.md
            
            # Check for key files
            if [ -f "$dir/package.json" ]; then
              echo "- âœ… Has package.json" >> analysis-report.md
            fi
            if [ -d "$dir/src" ]; then
              echo "- âœ… Has src directory" >> analysis-report.md
            fi
            if [ -f "$dir/README.md" ]; then
              echo "- âœ… Has README" >> analysis-report.md
            fi
            echo "" >> analysis-report.md
          fi
        done
        
        echo "" >> analysis-report.md
        echo "## Summary" >> analysis-report.md
        echo "" >> analysis-report.md
        echo "- Total files to analyze: $TOTAL_FILES" >> analysis-report.md
        echo "- Repositories processed: $(ls -d source_repos/* 2>/dev/null | wc -l)" >> analysis-report.md
        echo "" >> analysis-report.md
        
        cat analysis-report.md
        
        echo "analyzed=true" >> $GITHUB_OUTPUT
    
    - name: Identify best components
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        steps.config.outputs.enabled == 'true' &&
        steps.analyze.outputs.analyzed == 'true'
      run: |
        echo "Identifying best components across repositories..."
        
        cat >> analysis-report.md << EOF
        ## Component Analysis
        
        EOF
        
        # Look for unique/better implementations
        declare -A components
        
        for dir in source_repos/*; do
          if [ -d "$dir" ]; then
            repo_name=$(basename "$dir")
            
            # Check for trading components
            if [ -d "$dir/src/quantum" ] || [ -d "$dir/quantum" ]; then
              echo "- $repo_name: Has quantum trading components" >> analysis-report.md
              components["quantum"]="$repo_name"
            fi
            
            # Check for AI components
            if [ -d "$dir/src/ai" ] || [ -d "$dir/ai" ]; then
              echo "- $repo_name: Has AI components" >> analysis-report.md
              components["ai"]="$repo_name"
            fi
            
            # Check for dashboard
            if [ -d "$dir/src/dashboard" ] || [ -d "$dir/dashboard" ]; then
              echo "- $repo_name: Has dashboard" >> analysis-report.md
              components["dashboard"]="$repo_name"
            fi
          fi
        done
        
        cat analysis-report.md
    
    - name: Extract and merge improvements
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        steps.config.outputs.enabled == 'true' &&
        github.event.inputs.dry_run == 'false'
      run: |
        echo "Extracting improvements (this would merge best components in live mode)..."
        echo "Currently in dry-run or analysis mode - no files will be modified"
        
        # In live mode, this would:
        # 1. Copy superior implementations
        # 2. Merge package.json dependencies
        # 3. Update documentation
        # 4. Preserve our configuration
        
        cat >> analysis-report.md << EOF
        
        ## Consolidation Actions (Dry Run)
        
        The following actions would be taken in live mode:
        
        1. Extract improved components from source repositories
        2. Merge superior implementations while preserving current functionality
        3. Update dependencies with new packages
        4. Consolidate documentation
        5. Run tests to verify integration
        
        **Note:** This is a dry run. No changes were made.
        EOF
    
    - name: Run tests
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        steps.config.outputs.enabled == 'true' &&
        github.event.inputs.dry_run == 'false'
      run: |
        echo "Running tests to verify consolidation..."
        npm ci || true
        npm test || echo "Tests completed with warnings"
    
    - name: Create consolidation PR
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        steps.config.outputs.enabled == 'true' &&
        github.event.inputs.dry_run == 'false' &&
        steps.analyze.outputs.analyzed == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          // Check if there are changes
          try {
            execSync('git diff --quiet');
            console.log('No changes to commit');
            return;
          } catch (e) {
            // Changes exist, continue
          }
          
          const branch = `consolidation/auto-merge-${Date.now()}`;
          
          try {
            execSync(`git checkout -b ${branch}`);
            execSync('git add .');
            execSync('git commit -m "ðŸ”„ Automated consolidation of best components"');
            execSync(`git push origin ${branch}`);
            
            const analysisReport = fs.readFileSync('analysis-report.md', 'utf8');
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”„ Smart Repository Consolidation',
              head: branch,
              base: 'main',
              body: `${analysisReport}\n\n---\n*Automated by Chimera Autonomous System*`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['automated', 'consolidation']
            });
            
            console.log(`Created consolidation PR: #${pr.data.number}`);
          } catch (error) {
            console.error('Error creating PR:', error.message);
          }
    
    - name: Generate report
      if: always() && steps.killswitch.outputs.disabled == 'false'
      run: |
        if [ -f "analysis-report.md" ]; then
          cat analysis-report.md
        else
          echo "No analysis report generated"
        fi
    
    - name: Cleanup
      if: always()
      run: |
        echo "Cleaning up temporary files..."
        rm -rf source_repos
        echo "Cleanup complete"
