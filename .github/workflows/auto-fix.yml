name: Autonomous Auto-Fix

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: false
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  auto-fix:
    # Only run if issue has 'autonomous-task' or 'auto-fix' label
    if: |
      (github.event_name == 'issues' && 
       (contains(github.event.issue.labels.*.name, 'autonomous-task') ||
        contains(github.event.issue.labels.*.name, 'auto-fix'))) ||
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check for kill switch
      id: killswitch
      run: |
        if [ -f ".chimera/AUTONOMOUS_DISABLED" ]; then
          echo "AUTONOMOUS SYSTEM DISABLED - Kill switch active"
          echo "disabled=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        echo "disabled=false" >> $GITHUB_OUTPUT
    
    - name: Setup Node.js
      if: steps.killswitch.outputs.disabled == 'false'
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Install dependencies
      if: steps.killswitch.outputs.disabled == 'false'
      run: npm ci
    
    - name: Parse issue
      if: steps.killswitch.outputs.disabled == 'false'
      id: parse
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issueNumber = context.payload.issue ? context.payload.issue.number : '${{ github.event.inputs.issue_number }}';
          
          if (!issueNumber) {
            core.setFailed('No issue number provided');
            return;
          }
          
          const issue = await github.rest.issues.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: parseInt(issueNumber)
          });
          
          const title = issue.data.title;
          const body = issue.data.body;
          
          // Determine fix type
          let fixType = 'unknown';
          if (title.toLowerCase().includes('lint')) {
            fixType = 'linting';
          } else if (title.toLowerCase().includes('test')) {
            fixType = 'testing';
          } else if (title.toLowerCase().includes('dependency') || title.toLowerCase().includes('dependencies')) {
            fixType = 'dependencies';
          } else if (title.toLowerCase().includes('security')) {
            fixType = 'security';
          }
          
          core.setOutput('issue_number', issueNumber);
          core.setOutput('fix_type', fixType);
          core.setOutput('title', title);
    
    - name: Apply linting fixes
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        steps.parse.outputs.fix_type == 'linting'
      run: |
        echo "Applying automatic linting fixes..."
        npm run lint:fix || true
        
        # Check if files were changed
        if git diff --quiet; then
          echo "no_changes=true" >> $GITHUB_ENV
        else
          echo "no_changes=false" >> $GITHUB_ENV
        fi
    
    - name: Update dependencies
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        steps.parse.outputs.fix_type == 'dependencies'
      run: |
        echo "Updating dependencies..."
        npm update || true
        
        if git diff --quiet package-lock.json; then
          echo "no_changes=true" >> $GITHUB_ENV
        else
          echo "no_changes=false" >> $GITHUB_ENV
        fi
    
    - name: Fix security vulnerabilities
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        steps.parse.outputs.fix_type == 'security'
      run: |
        echo "Fixing security vulnerabilities..."
        npm audit fix || true
        
        if git diff --quiet; then
          echo "no_changes=true" >> $GITHUB_ENV
        else
          echo "no_changes=false" >> $GITHUB_ENV
        fi
    
    - name: Create branch and commit
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        env.no_changes == 'false'
      run: |
        BRANCH="autofix/issue-${{ steps.parse.outputs.issue_number }}"
        git config user.name "Chimera Auto-Fix Bot"
        git config user.email "chimera-bot@github-actions"
        
        git checkout -b "$BRANCH"
        git add .
        git commit -m "ðŸ¤– Auto-fix: ${{ steps.parse.outputs.title }}

        Automated fix for issue #${{ steps.parse.outputs.issue_number }}
        Fix type: ${{ steps.parse.outputs.fix_type }}
        
        This PR was created automatically by the Chimera Autonomous System."
        
        git push origin "$BRANCH"
        
        echo "branch=$BRANCH" >> $GITHUB_ENV
    
    - name: Run tests
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        env.no_changes == 'false'
      id: tests
      run: |
        npm test || true
        echo "Tests completed"
    
    - name: Create pull request
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        env.no_changes == 'false'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const pr = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ¤– Auto-fix: ${{ steps.parse.outputs.title }}',
            head: process.env.branch,
            base: 'main',
            body: `## Automated Fix
          
          This PR automatically fixes issue #${{ steps.parse.outputs.issue_number }}
          
          **Fix Type:** ${{ steps.parse.outputs.fix_type }}
          
          ### Changes Made
          
          - Applied automatic fixes based on issue analysis
          - Ran linting and formatting where applicable
          - Tested changes (see workflow logs)
          
          ### Safety Checks
          
          - âœ… Tests completed
          - âœ… No manual trading operations
          - âœ… No sensitive data modified
          - âœ… Changes are reversible
          
          ### Review Required
          
          Please review these automated changes before merging.
          
          ---
          *Automated by Chimera Autonomous System*
          Closes #${{ steps.parse.outputs.issue_number }}`
          });
          
          // Add label to PR
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: pr.data.number,
            labels: ['automated', 'auto-fix']
          });
          
          // Comment on issue
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ steps.parse.outputs.issue_number }},
            body: `ðŸ¤– Auto-fix PR created: #${pr.data.number}\n\nPlease review the automated changes.`
          });
    
    - name: Comment if no changes
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        env.no_changes == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ steps.parse.outputs.issue_number }},
            body: 'ðŸ¤– Auto-fix attempted but no changes were needed. The issue may require manual intervention.'
          });
