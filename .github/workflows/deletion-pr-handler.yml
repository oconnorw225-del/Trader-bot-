name: Handle Deletion-Only PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  check-deletion-only:
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR is deletion-only
        id: check-deletions
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            
            const totalAdditions = files.reduce((sum, file) => sum + file.additions, 0);
            const totalDeletions = files.reduce((sum, file) => sum + file.deletions, 0);
            const filesDeleted = files.filter(f => f.status === 'removed').length;
            const totalFiles = files.length;
            
            console.log(`PR Stats: ${totalAdditions} additions, ${totalDeletions} deletions, ${filesDeleted}/${totalFiles} files deleted`);
            
            // Consider it deletion-only if all files are removed OR no additions with deletions
            const isDeletionOnly = (filesDeleted === totalFiles && totalFiles > 0) || 
                                  (totalAdditions === 0 && totalDeletions > 0);
            
            core.setOutput('is_deletion_only', isDeletionOnly);
            core.setOutput('total_additions', totalAdditions);
            core.setOutput('total_deletions', totalDeletions);
            core.setOutput('files_deleted', filesDeleted);
            core.setOutput('total_files', totalFiles);
            
            return isDeletionOnly;

      - name: Comment on deletion-only PR
        if: steps.check-deletions.outputs.is_deletion_only == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const additions = '${{ steps.check-deletions.outputs.total_additions }}';
            const deletions = '${{ steps.check-deletions.outputs.total_deletions }}';
            const filesDeleted = '${{ steps.check-deletions.outputs.files_deleted }}';
            const totalFiles = '${{ steps.check-deletions.outputs.total_files }}';
            
            const commentBody = `## ✅ Deletion-Only PR Detected
            
            This PR appears to be focused on removing files/code rather than adding or modifying code.
            
            **PR Statistics:**
            - **Files changed:** ${totalFiles} (${filesDeleted} deleted)
            - **Lines added:** ${additions}
            - **Lines deleted:** ${deletions}
            
            **Note about Copilot PR Review:**
            GitHub Copilot PR reviewer is designed to analyze code changes and provide feedback on new or modified code. Since this PR only removes files, there is no code for Copilot to review. This is expected behavior and not an error.
            
            **What this means:**
            - ✅ This is normal for cleanup/deletion PRs
            - ✅ The PR can still be safely merged if tests pass and changes are approved
            - ✅ Manual review should focus on verifying the deletions are intentional and safe
            
            **Reviewer Checklist:**
            - [ ] Verify all deleted files are truly redundant or obsolete
            - [ ] Confirm no broken references to deleted files exist
            - [ ] Check that tests still pass after deletions
            - [ ] Ensure documentation is updated if needed
            
            <sub>This comment was automatically generated by the deletion-pr-handler workflow.</sub>`;
            
            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Deletion-Only PR Detected')
            );
            
            if (botComment) {
              console.log('Updating existing comment');
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              console.log('Creating new comment');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });
            }
