name: Branch Cleanup Helper

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - 'list-branches'
          - 'delete-obsolete'
          - 'create-merge-prs'
      dry_run:
        description: 'Dry run (no actual changes)'
        required: false
        type: boolean
        default: true

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup GitHub CLI
        run: |
          type -p gh >/dev/null || (echo "GitHub CLI not found" && exit 1)
          
      - name: List all branches
        if: inputs.action == 'list-branches'
        run: |
          echo "## All Remote Branches"
          git fetch --all --prune
          git branch -r | sort | tee branches.txt
          echo ""
          echo "Total branches: $(cat branches.txt | wc -l)"
          
      - name: Delete obsolete branches
        if: inputs.action == 'delete-obsolete'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## Deleting Obsolete Branches"
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN MODE - No changes will be made"
            echo ""
          fi
          
          # Define branches to delete
          BRANCHES_TO_DELETE=(
            "copilot/improve-variable-and-function-names"
            "copilot/improve-variable-function-names"
            "copilot/setup-copilot-instructions"
            "copilot/setup-copilot-instructions-again"
            "copilot/setup-copilot-instructions-another-one"
            "copilot/rebase-copilot-instructions-branch"
            "copilot/add-todo-list-application"
            "copilot/add-wallet-for-bots"
            "copilot/finish-original-issue"
            "copilot/fix-copilot-access-issue"
            "copilot/fix-copilot-review-issue"
            "copilot/fix-copilot-review-issue-again"
            "copilot/fix-failjob-async-await-issue"
            "copilot/fix-pull-request-comments"
            "copilot/resolve-get-it-done-issue"
            "copilot/resolve-pull-request-overview-issues"
            "copilot/status-report"
            "copilot/remove-all-duplicates"
            "copilot/remove-fork-invitation"
            "copilot/remove-forking-allowance"
            "copilot/update-forking-to-false"
            "copilot/revoke-vlones-access"
            "copilot/clean-up-branches-and-push"
            "copilot/numerous-pigeon"
            "copilot/run-command-in-terminal"
          )
          
          # Add all autopilot fix branches
          AUTOPILOT_BRANCHES=$(git branch -r | grep 'origin/autopilot/fix-' | sed 's|origin/||' || true)
          
          DELETED=0
          SKIPPED=0
          
          for branch in "${BRANCHES_TO_DELETE[@]}" $AUTOPILOT_BRANCHES; do
            if git ls-remote --heads origin "$branch" | grep -q "$branch"; then
              echo "Deleting: $branch"
              if [ "${{ inputs.dry_run }}" != "true" ]; then
                gh api -X DELETE "repos/${{ github.repository }}/git/refs/heads/$branch" && ((DELETED++)) || ((SKIPPED++))
              else
                echo "  [DRY RUN] Would delete $branch"
                ((DELETED++))
              fi
            else
              echo "  Skip: $branch (doesn't exist)"
              ((SKIPPED++))
            fi
          done
          
          echo ""
          echo "Summary:"
          echo "  Deleted: $DELETED"
          echo "  Skipped: $SKIPPED"
          
      - name: Create merge PRs
        if: inputs.action == 'create-merge-prs'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## Creating Merge Pull Requests"
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN MODE - No PRs will be created"
            echo ""
          fi
          
          # Priority branches to merge
          PRIORITY_BRANCHES=(
            "feature/autonomous-job-automation-complete"
            "feature/auto-start-system"
            "fix/lint-and-tests"
            "copilot/configure-copilot-instructions"
            "copilot/fix-ci-cd-workflow-issues"
            "copilot/add-autostart-system-features"
            "copilot/consolidate-mobile-styles"
            "copilot/add-todo-list-feature"
          )
          
          CREATED=0
          SKIPPED=0
          
          for branch in "${PRIORITY_BRANCHES[@]}"; do
            if git ls-remote --heads origin "$branch" | grep -q "$branch"; then
              echo "Creating PR for: $branch"
              
              # Check if PR already exists
              EXISTING_PR=$(gh pr list --head "$branch" --json number --jq '.[0].number' || echo "")
              
              if [ -n "$EXISTING_PR" ]; then
                echo "  PR already exists: #$EXISTING_PR"
                ((SKIPPED++))
                continue
              fi
              
              if [ "${{ inputs.dry_run }}" != "true" ]; then
                gh pr create \
                  --base main \
                  --head "$branch" \
                  --title "Merge: $branch" \
                  --body "Automated PR for branch consolidation. Please review conflicts and merge when ready." \
                  --label "branch-cleanup" && ((CREATED++)) || ((SKIPPED++))
              else
                echo "  [DRY RUN] Would create PR for $branch"
                ((CREATED++))
              fi
            else
              echo "  Skip: $branch (doesn't exist)"
              ((SKIPPED++))
            fi
          done
          
          echo ""
          echo "Summary:"
          echo "  Created: $CREATED"
          echo "  Skipped: $SKIPPED"
