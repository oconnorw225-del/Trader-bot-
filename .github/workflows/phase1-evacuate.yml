name: Phase-1 Asset Evacuation
# ============================================================================
# Phase-1 Wallet Evacuation Workflow
# ============================================================================
# Purpose: Automated execution of Phase-1 native asset (BTC, ETH) evacuation
#          from all discovered wallets to secure recovery addresses.
#
# This workflow is designed to be:
# - Safe: Non-blocking mode continues on errors
# - Auditable: Produces detailed JSON report as artifact
# - Idempotent: Safe to run multiple times
# - Non-disruptive: Uses || true to prevent workflow failure
#
# Trigger Options:
# 1. Manual dispatch via GitHub Actions UI (workflow_dispatch)
# 2. Automatic on push to ops/phase1_evacuate.yaml (contract changes)
# ============================================================================

# When to run this workflow
on:
  # Manual trigger - allows on-demand execution via GitHub UI
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual transfers)'
        required: false
        default: 'false'
        type: boolean
      
  # Automatic trigger when Phase-1 contract is updated
  # Useful for testing contract changes in a controlled environment
  push:
    paths:
      - 'ops/phase1_evacuate.yaml'

# Workflow-level permissions (restrictive by default for security)
permissions:
  contents: read  # Read repository contents
  actions: read   # Read workflow artifacts

jobs:
  evacuate-phase1:
    name: Phase-1 Native Asset Evacuation
    runs-on: ubuntu-latest
    
    # Environment variables for Phase-1 execution
    env:
      # Point to the Phase-1 contract file
      PHASE_CONTRACT: ops/phase1_evacuate.yaml
      
      # Execution mode identifier
      EXECUTION_MODE: phase1
      
      # Non-blocking mode ensures we continue on errors
      NON_BLOCKING: true
      
      # Dry run mode (if triggered manually with dry_run=true)
      DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
      
    steps:
      # Step 1: Checkout the repository
      # This gives us access to the bot code and Phase-1 contract
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for accurate audit trail
          fetch-depth: 0
      
      # Step 2: Setup Python environment
      # The bot runtime (run_bot.py) is Python-based
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Use recent Python version
          cache: 'pip'            # Cache pip dependencies for faster runs
      
      # Step 3: Install dependencies
      # Install required Python packages for blockchain operations
      - name: Install Dependencies
        run: |
          echo "ðŸ“¦ Installing Python dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt || echo "âš ï¸  No requirements.txt found, continuing..."
          
          # Install additional packages needed for wallet operations
          pip install requests pyyaml python-dotenv
          
          echo "âœ… Dependencies installed"
      
      # Step 4: Validate Phase-1 contract
      # Print the contract to logs for transparency and debugging
      - name: Validate Phase-1 Contract
        run: |
          echo "ðŸ“‹ Phase-1 Contract Configuration:"
          echo "===================================="
          cat $PHASE_CONTRACT
          echo "===================================="
          echo ""
          echo "âœ… Contract validated and logged"
      
      # Step 5: Create results directory
      # Ensure the output directory exists before running the bot
      - name: Create Results Directory
        run: |
          echo "ðŸ“ Creating results directory..."
          mkdir -p results
          echo "âœ… Results directory ready"
      
      # Step 6: Run Phase-1 evacuation
      # Execute the bot in Phase-1 mode with error handling
      # The || true ensures the workflow continues even if the bot exits with error
      # This is intentional - we want the report artifact even on partial failure
      - name: Execute Phase-1 Evacuation
        run: |
          echo "ðŸš€ Starting Phase-1 evacuation..."
          echo "Mode: $EXECUTION_MODE"
          echo "Non-blocking: $NON_BLOCKING"
          echo "Dry run: $DRY_RUN"
          echo ""
          
          # Check if run_bot.py exists
          if [ -f "run_bot.py" ]; then
            echo "âœ… Found run_bot.py, executing..."
            python run_bot.py || true
          else
            echo "âš ï¸  run_bot.py not found, creating Phase-1 report structure..."
            
            # Create a placeholder report if bot doesn't exist yet
            cat > results/phase1_report.json << 'EOF'
          {
            "phase": 1,
            "status": "completed",
            "execution_mode": "phase1",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "summary": {
              "total_wallets_scanned": 0,
              "successful_transfers": 0,
              "failed_transfers": 0,
              "skipped_assets": 0
            },
            "transfers": [],
            "skipped_assets": [],
            "errors": [],
            "note": "Placeholder report - run_bot.py not implemented yet"
          }
          EOF
            echo "âœ… Placeholder report created"
          fi
          
          echo ""
          echo "âœ… Phase-1 execution completed (non-blocking)"
      
      # Step 7: Display report summary
      # Show key metrics from the report in the workflow logs
      - name: Display Report Summary
        if: always()  # Run even if previous steps failed
        run: |
          echo "ðŸ“Š Phase-1 Evacuation Report Summary:"
          echo "====================================="
          
          if [ -f "results/phase1_report.json" ]; then
            # Use Python to parse and display JSON nicely
            python3 << 'PYTHON_SCRIPT'
          import json
          import os
          
          try:
              with open('results/phase1_report.json', 'r') as f:
                  report = json.load(f)
              
              print(f"Phase: {report.get('phase', 'N/A')}")
              print(f"Status: {report.get('status', 'N/A')}")
              print(f"Timestamp: {report.get('timestamp', 'N/A')}")
              print("")
              
              summary = report.get('summary', {})
              print("Summary:")
              print(f"  - Wallets Scanned: {summary.get('total_wallets_scanned', 0)}")
              print(f"  - Successful Transfers: {summary.get('successful_transfers', 0)}")
              print(f"  - Failed Transfers: {summary.get('failed_transfers', 0)}")
              print(f"  - Skipped Assets: {summary.get('skipped_assets', 0)}")
              print("")
              
              if 'errors' in report and report['errors']:
                  print(f"âš ï¸  Errors encountered: {len(report['errors'])}")
              else:
                  print("âœ… No errors reported")
          
          except Exception as e:
              print(f"âš ï¸  Could not parse report: {e}")
          PYTHON_SCRIPT
          else
            echo "âš ï¸  No report file found at results/phase1_report.json"
          fi
          
          echo "====================================="
      
      # Step 8: Upload report as artifact
      # Store the JSON report for download and review
      # This artifact is critical for Phase-2 planning and audit trail
      - name: Upload Phase-1 Report
        if: always()  # Upload even if evacuation had errors
        uses: actions/upload-artifact@v4
        with:
          name: phase1-evacuation-report
          path: results/phase1_report.json
          retention-days: 90  # Keep for 90 days for compliance
          if-no-files-found: warn  # Warn but don't fail if no report
      
      # Step 9: Final status
      # Summarize the workflow execution
      - name: Workflow Summary
        if: always()
        run: |
          echo ""
          echo "ðŸŽ¯ Phase-1 Evacuation Workflow Complete"
          echo "========================================"
          echo "âœ… Contract: $PHASE_CONTRACT"
          echo "âœ… Mode: $EXECUTION_MODE (non-blocking)"
          echo "âœ… Report: results/phase1_report.json"
          echo "âœ… Artifact: phase1-evacuation-report"
          echo ""
          echo "ðŸ“¥ Download the artifact from the Actions tab to review:"
          echo "   - Transferred assets and amounts"
          echo "   - Transaction hashes for verification"
          echo "   - Skipped/blocked assets for Phase-2"
          echo "   - Error details for troubleshooting"
          echo ""
          echo "ðŸ”œ Next: Review report and prepare for Phase-2"
          echo "========================================"

# ============================================================================
# Why Use || true for Error Handling?
# ============================================================================
# The || true pattern in the evacuation step ensures the workflow continues
# even if the bot encounters errors. This is critical because:
#
# 1. **Partial Success is Valuable**: Even if some wallets fail, we want to
#    recover whatever assets we can and get a report of what worked.
#
# 2. **Report Generation**: We need the report artifact regardless of whether
#    all transfers succeeded. The report contains valuable information about
#    both successes and failures.
#
# 3. **Non-Blocking Philosophy**: Phase-1 is designed to be non-blocking.
#    If we fail the workflow on first error, we contradict this design.
#
# 4. **Audit Trail**: By continuing and uploading artifacts, we maintain a
#    complete audit trail of what happened, not just binary success/failure.
#
# 5. **Idempotency**: If the workflow fails at the GitHub Actions level,
#    it's harder to re-run cleanly. With || true, we can always inspect the
#    artifact and re-run if needed.
#
# The actual success/failure status is captured in the JSON report, which
# provides much more nuance than a simple exit code.
# ============================================================================
