name: Phase-1 Asset Evacuation (DRY-RUN)
# ============================================================================
# Phase-1 Wallet Evacuation Workflow - DRY-RUN MODE
# ============================================================================
# Purpose: Safely simulate Phase-1 native asset (BTC, ETH) evacuation from
#          all discovered wallets to secure recovery addresses.
#
# THIS IS A DRY-RUN / SIMULATION ONLY:
# - NO actual BTC or ETH will be moved
# - NO gas will be consumed
# - NO transactions will be signed
# - NO transactions will be sent to blockchain
#
# This workflow is designed to be:
# - Safe: Non-blocking mode continues on errors
# - Auditable: Produces detailed JSON report as artifact
# - Idempotent: Safe to run multiple times
# - Non-disruptive: Uses || true to prevent workflow failure
# - Simulation-only: All transfers are simulated, no real blockchain interaction
#
# Trigger Options:
# 1. Manual dispatch via GitHub Actions UI (workflow_dispatch)
# 2. Automatic on push to ops/phase1_evacuate.yaml (contract changes)
# ============================================================================

# When to run this workflow
on:
  # Manual trigger - allows on-demand execution via GitHub UI
  workflow_dispatch:
      
  # Automatic trigger when Phase-1 contract is updated
  # Useful for testing contract changes in a controlled environment
  push:
    paths:
      - 'ops/phase1_evacuate.yaml'

# Workflow-level permissions (restrictive by default for security)
permissions:
  contents: read  # Read repository contents only

jobs:
  phase1-evacuate:
    name: Phase-1 Non-Blocking Evacuation (Simulation)
    runs-on: ubuntu-latest
    
    # Environment variables for Phase-1 execution
    env:
      # Point to the Phase-1 contract file
      PHASE_CONTRACT: ops/phase1_evacuate.yaml
      
      # Execution mode identifier
      EXECUTION_MODE: phase1
      
      # Non-blocking mode ensures we continue on errors
      NON_BLOCKING: "true"
      
      # Dry run mode - ALWAYS TRUE for this workflow
      DRY_RUN: "true"
      
      # Chimera coordinator mode
      COORDINATOR: chimera
      
      # Safety flags - disable all write operations
      ALLOW_SIGNING: "false"
      ALLOW_SENDING: "false"
      
    steps:
      # Step 1: Checkout the repository
      # This gives us access to the bot code and Phase-1 contract
      - name: Checkout trader-bot repository
        uses: actions/checkout@v4
      
      # Step 2: Setup Python environment
      # The bot runtime (run_bot.py) is Python-based
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # Step 3: Install dependencies
      # Install required Python packages for blockchain operations
      - name: Install dependencies
        run: |
          pip install -r requirements.txt || true
      
      # Step 4: Create results directory
      # Ensure the output directory exists before running the bot
      - name: Ensure results directory exists
        run: |
          mkdir -p results
      
      # Step 5: Validate Phase-1 contract
      # Print the contract to logs for transparency and debugging
      - name: Validate Phase-1 contract
        run: |
          echo "----- PHASE-1 CONTRACT -----"
          cat ops/phase1_evacuate.yaml
          echo "----------------------------"
      
      # Step 6: Start Chimera coordinator in audit mode
      # Chimera coordinates the evacuation process autonomously
      - name: Start Chimera coordinator (audit mode)
        run: |
          python bots/chimera.py \
            --mode audit \
            --role coordinator \
            --phase 1 \
            --dry-run \
            --non-blocking || true
      
      # Step 7: Execute Phase-1 evacuation simulation
      # The || true ensures the workflow continues even if the bot exits with error
      # This is intentional - we want the report artifact even on partial failure
      - name: Execute Phase-1 evacuation (simulation only)
        run: |
          python run_bot.py \
            --phase-contract ops/phase1_evacuate.yaml \
            --dry-run \
            --non-blocking || true
      
      # Step 8: Upload report as artifact
      # Store the JSON report for download and review
      # This artifact is critical for Phase-2 planning and audit trail
      - name: Upload Phase-1 report artifact
        uses: actions/upload-artifact@v4
        with:
          name: phase1-evacuation-report
          path: results/phase1_report.json
