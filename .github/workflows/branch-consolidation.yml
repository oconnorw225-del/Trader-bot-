name: Branch Consolidation
on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no PR creation)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  consolidate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run branch consolidation script
        id: consolidate
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            bash scripts/merge-and-deduplicate-branches.sh --dry-run
          else
            bash scripts/merge-and-deduplicate-branches.sh
          fi
        continue-on-error: true

      - name: Check if consolidation succeeded
        id: check_consolidation
        run: |
          if [ -f "CONSOLIDATION_REPORT.md" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload consolidation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: consolidation-report
          path: CONSOLIDATION_REPORT.md
          if-no-files-found: warn

      - name: Run tests
        if: steps.check_consolidation.outputs.success == 'true' && inputs.dry_run == false
        run: npm test
        continue-on-error: true

      - name: Run linting
        if: steps.check_consolidation.outputs.success == 'true' && inputs.dry_run == false
        run: npm run lint
        continue-on-error: true

      - name: Create Pull Request
        if: steps.check_consolidation.outputs.success == 'true' && inputs.dry_run == false
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Consolidate all branches - $(date +%Y%m%d)"
          branch: consolidation/merge-all-branches-${{ github.run_number }}
          delete-branch: true
          title: "ðŸ”€ Branch Consolidation - Merge All Unique Branches"
          body: |
            ## Branch Consolidation
            
            This PR consolidates all unique branches from the repository while eliminating duplicates.
            
            ### What This PR Does
            
            - âœ… Merges all unique branches (eliminates duplicates)
            - âœ… Automatically resolves merge conflicts using `--ours` strategy
            - âœ… Cherry-picks valuable commits from archive branches
            - âœ… Preserves all unique code from non-duplicate branches
            
            ### Consolidation Report
            
            See the uploaded artifact for the full consolidation report with:
            - Summary statistics (branches analyzed, merged, skipped)
            - List of duplicate groups identified
            - All branches merged with file change counts
            - Recommended branches for deletion
            
            ### Testing
            
            - Tests have been run on the consolidation branch
            - Linting has been performed
            - Review the report artifact for detailed information
            
            ### Next Steps
            
            1. Review this PR carefully
            2. Check the consolidation report artifact
            3. Verify tests are passing
            4. Merge when ready
            5. After merge, run cleanup script:
               ```bash
               bash scripts/cleanup-duplicate-branches.sh
               ```
            
            ### Safety
            
            This consolidation is non-destructive:
            - No branches are deleted automatically
            - All changes are in this PR for review
            - Cleanup must be run manually after merge
            
            ---
            
            **Generated by:** `.github/workflows/branch-consolidation.yml`
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          labels: |
            consolidation
            enhancement
            automation
          draft: false

      - name: Comment on workflow result
        if: always()
        run: |
          if [ "${{ steps.check_consolidation.outputs.success }}" = "true" ]; then
            echo "âœ… Consolidation completed successfully"
            echo "ðŸ“„ Check the consolidation report artifact"
            if [ "${{ inputs.dry_run }}" = "false" ]; then
              echo "ðŸ”€ Pull request has been created"
            else
              echo "ðŸ” Dry run completed - no PR created"
            fi
          else
            echo "âŒ Consolidation failed"
            echo "Check the logs for details"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Branch Consolidation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ” **Dry Run Mode** - No changes were made" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "CONSOLIDATION_REPORT.md" ]; then
            echo "### Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            grep -A 10 "## Summary Statistics" CONSOLIDATION_REPORT.md | tail -n +3 >> $GITHUB_STEP_SUMMARY || true
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“„ Full report available in artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No consolidation report generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests: ${{ steps.check_consolidation.outputs.success == 'true' && 'Completed' || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.dry_run }}" = "false" ]; then
            echo "- ðŸ”€ PR: Created" >> $GITHUB_STEP_SUMMARY
          fi
