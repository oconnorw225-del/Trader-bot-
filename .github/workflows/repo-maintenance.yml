name: Repository Maintenance

on:
  schedule:
    # Run weekly on Sunday at midnight
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      tasks:
        description: 'Maintenance tasks to run (comma-separated: dependencies,branches,issues,docs,security,performance)'
        required: false
        default: 'all'
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  maintenance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check for kill switch
      id: killswitch
      run: |
        if [ -f ".chimera/AUTONOMOUS_DISABLED" ]; then
          echo "AUTONOMOUS SYSTEM DISABLED - Kill switch active"
          echo "disabled=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        echo "disabled=false" >> $GITHUB_OUTPUT
    
    - name: Read configuration
      if: steps.killswitch.outputs.disabled == 'false'
      id: config
      run: |
        if [ -f ".chimera/autonomous-config.json" ]; then
          DEPS_ENABLED=$(cat .chimera/autonomous-config.json | grep -o '"dependency_updates":[^,]*' | grep -o 'true\|false')
          echo "deps_enabled=$DEPS_ENABLED" >> $GITHUB_OUTPUT
        else
          echo "deps_enabled=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Setup Node.js
      if: steps.killswitch.outputs.disabled == 'false'
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Install dependencies
      if: steps.killswitch.outputs.disabled == 'false'
      run: npm ci
    
    - name: Update dependencies
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        (github.event.inputs.tasks == 'all' || contains(github.event.inputs.tasks, 'dependencies')) &&
        steps.config.outputs.deps_enabled == 'true'
      id: deps
      run: |
        echo "Checking for dependency updates..."
        
        # Check for outdated packages
        npm outdated > outdated.txt 2>&1 || true
        
        if [ -s outdated.txt ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          
          # Update patch and minor versions only (safer)
          npm update --save || true
          
          # Generate update report
          cat > deps-report.md << EOF
        ## Dependency Updates
        
        Updated dependencies to latest compatible versions.
        
        ### Outdated packages before update:
        \`\`\`
        $(cat outdated.txt)
        \`\`\`
        
        ### Safety notes:
        - Only patch and minor updates applied
        - Major updates require manual review
        - All tests will be run before PR creation
        EOF
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
          echo "No dependency updates needed"
        fi
    
    - name: Clean old branches
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        (github.event.inputs.tasks == 'all' || contains(github.event.inputs.tasks, 'branches'))
      id: branches
      run: |
        echo "Checking for stale branches..."
        
        # Fetch all branches
        git fetch --all
        
        # Find branches older than 30 days with no recent commits
        STALE_BRANCHES=$(git for-each-ref --sort=-committerdate refs/remotes/origin/ --format='%(refname:short) %(committerdate:relative)' | grep 'month\|year' | head -10)
        
        if [ -n "$STALE_BRANCHES" ]; then
          echo "has_stale=true" >> $GITHUB_OUTPUT
          echo "$STALE_BRANCHES" > stale-branches.txt
          
          cat > branch-report.md << EOF
        ## Stale Branches Detected
        
        Found branches with no recent activity:
        
        \`\`\`
        $STALE_BRANCHES
        \`\`\`
        
        Consider reviewing and archiving these branches.
        EOF
        else
          echo "has_stale=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Archive completed issues
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        (github.event.inputs.tasks == 'all' || contains(github.event.inputs.tasks, 'issues'))
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Find old closed issues
          const threeMonthsAgo = new Date();
          threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
          
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'closed',
            since: threeMonthsAgo.toISOString(),
            per_page: 100
          });
          
          let archived = 0;
          for (const issue of issues.data) {
            // Add 'archived' label to old closed issues
            if (!issue.labels.find(l => l.name === 'archived')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['archived']
              });
              archived++;
            }
          }
          
          console.log(`Archived ${archived} old closed issues`);
    
    - name: Check documentation
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        (github.event.inputs.tasks == 'all' || contains(github.event.inputs.tasks, 'docs'))
      run: |
        echo "Checking documentation..."
        
        # Check for broken links in markdown files
        find . -name "*.md" -not -path "./node_modules/*" -not -path "./dist/*" | while read file; do
          # Basic check for common issues
          if grep -q "TODO\|FIXME\|XXX" "$file"; then
            echo "Found TODO items in: $file"
          fi
        done
        
        echo "Documentation check complete"
    
    - name: Security scan
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        (github.event.inputs.tasks == 'all' || contains(github.event.inputs.tasks, 'security'))
      id: security
      run: |
        echo "Running security audit..."
        
        npm audit --json > audit-results.json 2>&1 || true
        
        CRITICAL=$(cat audit-results.json | grep -o '"critical":[0-9]*' | grep -o '[0-9]*' || echo "0")
        HIGH=$(cat audit-results.json | grep -o '"high":[0-9]*' | grep -o '[0-9]*' || echo "0")
        
        echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
        
        if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
          echo "has_vulns=true" >> $GITHUB_OUTPUT
          
          cat > security-report.md << EOF
        ## Security Vulnerabilities Detected
        
        - Critical: $CRITICAL
        - High: $HIGH
        
        Run \`npm audit\` for full details.
        Consider running \`npm audit fix\` to automatically fix vulnerabilities.
        EOF
        else
          echo "has_vulns=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Performance optimization check
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        (github.event.inputs.tasks == 'all' || contains(github.event.inputs.tasks, 'performance'))
      run: |
        echo "Checking performance metrics..."
        
        # Check bundle size
        if [ -f "package.json" ]; then
          echo "Package size:" $(du -sh . | cut -f1)
          echo "node_modules size:" $(du -sh node_modules 2>/dev/null | cut -f1 || echo "N/A")
        fi
        
        # Check for large files
        find . -type f -size +1M -not -path "./node_modules/*" -not -path "./.git/*" | head -5
    
    - name: Run tests
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        steps.deps.outputs.has_updates == 'true'
      run: |
        echo "Running tests to verify updates..."
        npm test || echo "Some tests failed - review needed"
    
    - name: Create maintenance PR
      if: |
        steps.killswitch.outputs.disabled == 'false' &&
        steps.deps.outputs.has_updates == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          // Create branch
          const branch = `maintenance/auto-update-${Date.now()}`;
          
          try {
            const { execSync } = require('child_process');
            
            execSync('git config user.name "Chimera Maintenance Bot"');
            execSync('git config user.email "chimera-bot@github-actions"');
            execSync(`git checkout -b ${branch}`);
            execSync('git add .');
            execSync('git commit -m "ðŸ”§ Automated maintenance: dependency updates"');
            execSync(`git push origin ${branch}`);
            
            // Build PR body
            let body = '## Automated Maintenance\n\n';
            body += 'This PR contains automated maintenance updates.\n\n';
            
            if (fs.existsSync('deps-report.md')) {
              body += fs.readFileSync('deps-report.md', 'utf8') + '\n\n';
            }
            
            if (fs.existsSync('branch-report.md')) {
              body += fs.readFileSync('branch-report.md', 'utf8') + '\n\n';
            }
            
            if (fs.existsSync('security-report.md')) {
              body += fs.readFileSync('security-report.md', 'utf8') + '\n\n';
            }
            
            body += '---\n*Automated by Chimera Autonomous System*';
            
            // Create PR
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”§ Automated Maintenance Update',
              head: branch,
              base: 'main',
              body: body
            });
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['automated', 'maintenance']
            });
            
            console.log(`Created maintenance PR: #${pr.data.number}`);
          } catch (error) {
            console.error('Error creating PR:', error.message);
          }
    
    - name: Generate maintenance report
      if: always() && steps.killswitch.outputs.disabled == 'false'
      run: |
        cat > maintenance-report.md << EOF
        # Maintenance Report
        
        **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Tasks:** ${{ github.event.inputs.tasks || 'all' }}
        
        ## Results
        
        - Dependencies: ${{ steps.deps.outputs.has_updates == 'true' && 'Updated âœ…' || 'Up to date âœ…' }}
        - Stale Branches: ${{ steps.branches.outputs.has_stale == 'true' && 'Found âš ï¸' || 'None âœ…' }}
        - Security: ${{ steps.security.outputs.has_vulns == 'true' && 'Issues found ðŸš¨' || 'Clean âœ…' }}
        - Documentation: Checked âœ…
        - Performance: Analyzed âœ…
        
        ---
        *Automated by Chimera Autonomous System*
        EOF
        
        cat maintenance-report.md
